<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net" modified="2024-12-31" agent="Kiro" version="22.1.0">
<diagram id="csr-flow" name="CSR Certificate Signing">
<mxGraphModel dx="1400" dy="1000" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1100" math="0" shadow="0">
<root>
<mxCell id="0"/>
<mxCell id="1" parent="0"/>

<!-- Title -->
<mxCell id="title" value="CSR è¯ä¹¦ç­¾å‘æµç¨‹ (RKI CloudHSM CA) - v2.8" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=22;fontStyle=1;fontColor=#FF6000;" vertex="1" parent="1">
<mxGeometry x="350" y="15" width="500" height="35" as="geometry"/>
</mxCell>

<!-- Participants -->
<mxCell id="p1" value="ðŸ›¡ï¸ MPoC SDK" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#FF6000;strokeWidth=2;fontSize=13;fontStyle=1;" vertex="1" parent="1">
<mxGeometry x="80" y="70" width="140" height="35" as="geometry"/>
</mxCell>
<mxCell id="p2" value="ðŸ–¥ï¸ A/M-Backend" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FBE9E7;strokeColor=#FF6000;strokeWidth=2;fontSize=13;fontStyle=1;" vertex="1" parent="1">
<mxGeometry x="480" y="70" width="160" height="35" as="geometry"/>
</mxCell>
<mxCell id="p3" value="ðŸ” RKI CloudHSM" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF8E1;strokeColor=#E65100;strokeWidth=2;fontSize=13;fontStyle=1;" vertex="1" parent="1">
<mxGeometry x="880" y="70" width="170" height="35" as="geometry"/>
</mxCell>

<!-- Lifelines -->
<mxCell id="l1" style="endArrow=none;dashed=1;html=1;strokeWidth=2;strokeColor=#FF6000;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="150" y="105" as="sourcePoint"/>
<mxPoint x="150" y="950" as="targetPoint"/>
</mxGeometry>
</mxCell>
<mxCell id="l2" style="endArrow=none;dashed=1;html=1;strokeWidth=2;strokeColor=#FF6000;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="560" y="105" as="sourcePoint"/>
<mxPoint x="560" y="950" as="targetPoint"/>
</mxGeometry>
</mxCell>
<mxCell id="l3" style="endArrow=none;dashed=1;html=1;strokeWidth=2;strokeColor=#E65100;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="965" y="105" as="sourcePoint"/>
<mxPoint x="965" y="950" as="targetPoint"/>
</mxGeometry>
</mxCell>

<!-- Step 1: Local Key Generation -->
<mxCell id="s1bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=1;dashed=1;" vertex="1" parent="1">
<mxGeometry x="60" y="130" width="180" height="130" as="geometry"/>
</mxCell>
<mxCell id="s1t" value="â‘  æœ¬åœ°å¯†é’¥ç”Ÿæˆ" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#1976D2;" vertex="1" parent="1">
<mxGeometry x="70" y="135" width="120" height="18" as="geometry"/>
</mxCell>
<mxCell id="s1a" value="ç”Ÿæˆ ECC P-256 å¯†é’¥å¯¹" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="75" y="158" width="150" height="28" as="geometry"/>
</mxCell>
<mxCell id="s1b" value="å­˜å‚¨ç§é’¥åˆ° Android Keystore" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="75" y="192" width="150" height="28" as="geometry"/>
</mxCell>
<mxCell id="s1c" value="ç”Ÿæˆ PKCS#10 CSR (PEM)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="75" y="226" width="150" height="28" as="geometry"/>
</mxCell>

<!-- Step 2: Submit CSR -->
<mxCell id="s2arrow" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#FF6000;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="150" y="280" as="sourcePoint"/>
<mxPoint x="560" y="280" as="targetPoint"/>
</mxGeometry>
</mxCell>
<mxCell id="s2label" value="â‘¡ POST MPoC/api/certificates/sign&#xa;{deviceId, csr, keyAlgorithm: EC, curve: P-256}&#xa;Header: Authorization: Bearer &lt;accessToken&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=9;fontColor=#FF6000;" vertex="1" parent="1">
<mxGeometry x="220" y="285" width="280" height="40" as="geometry"/>
</mxCell>

<!-- Step 3: Backend Validation -->
<mxCell id="s3bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#388E3C;strokeWidth=1;dashed=1;" vertex="1" parent="1">
<mxGeometry x="470" y="340" width="180" height="80" as="geometry"/>
</mxCell>
<mxCell id="s3t" value="â‘¢ åŽç«¯éªŒè¯" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#388E3C;" vertex="1" parent="1">
<mxGeometry x="480" y="345" width="100" height="18" as="geometry"/>
</mxCell>
<mxCell id="s3a" value="éªŒè¯ accessToken æœ‰æ•ˆæ€§" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="485" y="368" width="150" height="22" as="geometry"/>
</mxCell>
<mxCell id="s3b" value="éªŒè¯è®¾å¤‡çŠ¶æ€ = APPROVED" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#C8E6C9;strokeColor=#388E3C;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="485" y="394" width="150" height="22" as="geometry"/>
</mxCell>

<!-- Step 4: Call HSM -->
<mxCell id="s4arrow" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#E65100;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="560" y="440" as="sourcePoint"/>
<mxPoint x="965" y="440" as="targetPoint"/>
</mxGeometry>
</mxCell>
<mxCell id="s4label" value="â‘£ POST /RKI/api/v1/ca/sign&#xa;{csr, certificateProfile: MPOC_DEVICE}" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=9;fontColor=#E65100;fontStyle=1;" vertex="1" parent="1">
<mxGeometry x="660" y="445" width="220" height="30" as="geometry"/>
</mxCell>

<!-- Step 5: HSM Processing -->
<mxCell id="s5bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF8E1;strokeColor=#E65100;strokeWidth=1;dashed=1;" vertex="1" parent="1">
<mxGeometry x="875" y="490" width="180" height="130" as="geometry"/>
</mxCell>
<mxCell id="s5t" value="â‘¤ HSM å®‰å…¨è¾¹ç•Œå†…å¤„ç†" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;fontStyle=1;fontColor=#E65100;" vertex="1" parent="1">
<mxGeometry x="885" y="495" width="160" height="18" as="geometry"/>
</mxCell>
<mxCell id="s5a" value="éªŒè¯ CSR ç­¾å" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#E65100;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="890" y="518" width="150" height="22" as="geometry"/>
</mxCell>
<mxCell id="s5b" value="æå–å…¬é’¥ (P-256)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#E65100;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="890" y="545" width="150" height="22" as="geometry"/>
</mxCell>
<mxCell id="s5c" value="æž„é€  X.509 è¯ä¹¦" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#E65100;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="890" y="572" width="150" height="22" as="geometry"/>
</mxCell>
<mxCell id="s5d" value="ä½¿ç”¨ Intermediate CA ç§é’¥ç­¾å" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCC80;strokeColor=#E65100;fontSize=9;fontStyle=1;" vertex="1" parent="1">
<mxGeometry x="890" y="599" width="150" height="18" as="geometry"/>
</mxCell>

<!-- Step 6: Return Certificate -->
<mxCell id="s6arrow" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#E65100;dashed=1;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="965" y="640" as="sourcePoint"/>
<mxPoint x="560" y="640" as="targetPoint"/>
</mxGeometry>
</mxCell>
<mxCell id="s6label" value="â‘¥ {certificate, certificateChain[]}" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=9;fontColor=#E65100;" vertex="1" parent="1">
<mxGeometry x="680" y="645" width="200" height="18" as="geometry"/>
</mxCell>

<!-- Step 7: Return to SDK -->
<mxCell id="s7arrow" value="" style="endArrow=classic;html=1;strokeWidth=2;strokeColor=#FF6000;dashed=1;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="560" y="680" as="sourcePoint"/>
<mxPoint x="150" y="680" as="targetPoint"/>
</mxGeometry>
</mxCell>
<mxCell id="s7label" value="â‘¦ {certificate, certificateChain, serialNumber, notBefore, notAfter}" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=9;fontColor=#FF6000;" vertex="1" parent="1">
<mxGeometry x="200" y="685" width="320" height="18" as="geometry"/>
</mxCell>

<!-- Step 8: Store Certificate -->
<mxCell id="s8bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E3F2FD;strokeColor=#1976D2;strokeWidth=1;dashed=1;" vertex="1" parent="1">
<mxGeometry x="60" y="720" width="180" height="80" as="geometry"/>
</mxCell>
<mxCell id="s8t" value="â‘§ å­˜å‚¨è¯ä¹¦" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=11;fontStyle=1;fontColor=#1976D2;" vertex="1" parent="1">
<mxGeometry x="70" y="725" width="100" height="18" as="geometry"/>
</mxCell>
<mxCell id="s8a" value="å­˜å‚¨è®¾å¤‡è¯ä¹¦åˆ° Android Keystore" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=9;" vertex="1" parent="1">
<mxGeometry x="75" y="748" width="150" height="22" as="geometry"/>
</mxCell>
<mxCell id="s8b" value="å­˜å‚¨è¯ä¹¦é“¾ (éªŒè¯ç”¨)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#BBDEFB;strokeColor=#1976D2;fontSize=9;" vertex="1" parent="1">
<mxGeometry x="75" y="774" width="150" height="22" as="geometry"/>
</mxCell>

</root>
</mxGraphModel>
</diagram>
</mxfile>

<!-- Continuing csr-certificate-signing-flow.drawio - Certificate Hierarchy and Notes -->

<!-- Certificate Hierarchy -->
<mxCell id="cert-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFF8E1;strokeColor=#E65100;strokeWidth=2;" vertex="1" parent="1">
<mxGeometry x="1100" y="130" width="220" height="200" as="geometry"/>
</mxCell>
<mxCell id="cert-title" value="ðŸ” è¯ä¹¦å±‚æ¬¡ç»“æž„" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=14;fontStyle=1;fontColor=#E65100;" vertex="1" parent="1">
<mxGeometry x="1130" y="140" width="160" height="25" as="geometry"/>
</mxCell>
<mxCell id="cert-root" value="SUNBAY Root CA&#xa;(è‡ªç­¾å, 10å¹´æœ‰æ•ˆæœŸ)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFE0B2;strokeColor=#E65100;fontSize=10;fontStyle=1;" vertex="1" parent="1">
<mxGeometry x="1130" y="175" width="160" height="35" as="geometry"/>
</mxCell>
<mxCell id="cert-int" value="SUNBAY MPoC Intermediate CA&#xa;(5å¹´æœ‰æ•ˆæœŸ)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFCC80;strokeColor=#E65100;fontSize=10;fontStyle=1;" vertex="1" parent="1">
<mxGeometry x="1130" y="220" width="160" height="35" as="geometry"/>
</mxCell>
<mxCell id="cert-dev" value="Device Certificate&#xa;(1å¹´æœ‰æ•ˆæœŸ, å¯ç»­æœŸ)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFB74D;strokeColor=#E65100;fontSize=10;fontStyle=1;" vertex="1" parent="1">
<mxGeometry x="1130" y="265" width="160" height="35" as="geometry"/>
</mxCell>
<mxCell id="cert-arrow1" value="" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#E65100;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="1210" y="210" as="sourcePoint"/>
<mxPoint x="1210" y="220" as="targetPoint"/>
</mxGeometry>
</mxCell>
<mxCell id="cert-arrow2" value="" style="endArrow=classic;html=1;strokeWidth=1;strokeColor=#E65100;" edge="1" parent="1">
<mxGeometry relative="1" as="geometry">
<mxPoint x="1210" y="255" as="sourcePoint"/>
<mxPoint x="1210" y="265" as="targetPoint"/>
</mxGeometry>
</mxCell>

<!-- Key Usage -->
<mxCell id="usage-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#E8F5E9;strokeColor=#388E3C;strokeWidth=2;" vertex="1" parent="1">
<mxGeometry x="1100" y="350" width="220" height="120" as="geometry"/>
</mxCell>
<mxCell id="usage-title" value="ðŸ“‹ è¯ä¹¦ç”¨é€” (Key Usage)" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=12;fontStyle=1;fontColor=#388E3C;" vertex="1" parent="1">
<mxGeometry x="1120" y="358" width="180" height="20" as="geometry"/>
</mxCell>
<mxCell id="usage-1" value="â€¢ digitalSignature - è¯·æ±‚ç­¾å" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="1115" y="385" width="190" height="16" as="geometry"/>
</mxCell>
<mxCell id="usage-2" value="â€¢ clientAuth - å®¢æˆ·ç«¯è®¤è¯" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="1115" y="405" width="190" height="16" as="geometry"/>
</mxCell>
<mxCell id="usage-3" value="â€¢ keyAgreement - ECDH å¯†é’¥åå•†" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=10;" vertex="1" parent="1">
<mxGeometry x="1115" y="425" width="190" height="16" as="geometry"/>
</mxCell>
<mxCell id="usage-note" value="Profile: MPOC_DEVICE" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=9;fontStyle=2;fontColor=#388E3C;" vertex="1" parent="1">
<mxGeometry x="1130" y="448" width="160" height="16" as="geometry"/>
</mxCell>

<!-- Important Notes -->
<mxCell id="note-bg" value="" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#FFEBEE;strokeColor=#C62828;strokeWidth=2;" vertex="1" parent="1">
<mxGeometry x="1100" y="490" width="220" height="150" as="geometry"/>
</mxCell>
<mxCell id="note-title" value="âš ï¸ é‡è¦è¯´æ˜Ž" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=12;fontStyle=1;fontColor=#C62828;" vertex="1" parent="1">
<mxGeometry x="1130" y="498" width="160" height="20" as="geometry"/>
</mxCell>
<mxCell id="note-1" value="â€¢ è¯ä¹¦æ˜¯ DUKPT å’Œ WhiteBox&#xa;  ä¸¤ç§æ¨¡å¼çš„å…±åŒå‰æ" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
<mxGeometry x="1115" y="522" width="190" height="28" as="geometry"/>
</mxCell>
<mxCell id="note-2" value="â€¢ ç§é’¥å­˜å‚¨åœ¨ Android Keystore&#xa;  ä¸å¯å¯¼å‡º" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
<mxGeometry x="1115" y="555" width="190" height="28" as="geometry"/>
</mxCell>
<mxCell id="note-3" value="â€¢ HSM API è·¯å¾„:&#xa;  /RKI/api/v1/ca/sign" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;fontStyle=1;fontColor=#E65100;" vertex="1" parent="1">
<mxGeometry x="1115" y="588" width="190" height="28" as="geometry"/>
</mxCell>
<mxCell id="note-4" value="â€¢ è¯ä¹¦è¿‡æœŸå‰å¯é€šè¿‡ CSR ç»­æœŸ" style="text;html=1;strokeColor=none;fillColor=none;align=left;fontSize=9;" vertex="1" parent="1">
<mxGeometry x="1115" y="618" width="190" height="16" as="geometry"/>
</mxCell>

<!-- Version -->
<mxCell id="version" value="Version: v2.8 | 2024-12-31 | HSM API: /RKI/api/v1/ca/sign" style="text;html=1;strokeColor=none;fillColor=none;align=center;fontSize=10;fontStyle=2;fontColor=#999;" vertex="1" parent="1">
<mxGeometry x="400" y="970" width="400" height="20" as="geometry"/>
</mxCell>

</root>
</mxGraphModel>
</diagram>
</mxfile>
