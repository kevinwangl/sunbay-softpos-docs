## 一、 背景与交流目标

### 1. 业务背景与核心诉求

SUNMI 拥有大量非金融设备（如商用平板、智能收银终端、手持设备等），这些设备广泛应用于零售、餐饮、物流等场景。核心诉求是：**为这些非金融设备叠加金融支付能力**，让它们能够直接受理银行卡/移动支付，无需额外配置专用 POS 终端。

然而，这带来了巨大挑战：**如何在通用 Android 设备上满足金融级安全与合规要求？** 传统 POS 依赖专用硬件安全芯片（SE），而通用设备面临 Root/Hook/调试/篡改等威胁，且设备碎片化严重（机型、OS 版本、TEE 能力差异大）。

### 2. SoftPOS：把通用 Android 手机变成支付受理终端

SoftPOS 的核心目标是：**把通用 Android 手机变成可用于支付受理的终端**，在满足安全/合规前提下，兼顾交付效率与工程可维护性。

### 3. 建设 SoftPOS 需要解决的核心问题

为 SUNMI 非金融设备叠加金融支付能力，本质上是在**非可信的通用 Android 环境**中构建**金融级安全与合规体系**。这带来四个核心工程挑战：

**挑战 1：如何在通用设备上构建金融级安全边界？**\
通用 Android 设备没有传统 POS 的安全芯片（SE），面临 Root/Hook/调试/篡改等威胁。如何在这样的环境中建立可信的隔离边界，保护密钥、PIN 等敏感材料？

**挑战 2：如何在非可信环境下保证密钥安全与交易可追溯？**\
密钥泄露影响面如何最小化？如何确保每笔交易的密钥使用可追溯？如何在交易前高效完成设备安全鉴证，同时不影响用户体验？

**挑战 3：如何高效复用 EMV 内核并支持快速迭代？**\
EMV L2 内核是高成本、难维护的 C 资产，如何在 Android 与 Web 演示环境中复用同一份逻辑？如何支持灰度发布、快速回滚，避免每次内核升级都要发版 App？

**挑战 4：如何构建系统架构支撑多组件协同与持续合规？**\
为什么不能做成单体 App + 后端？如何设计组件边界与协同机制？如何通过后台系统（A&M）支撑设备生命周期管理、风险监控、审计证据归档等合规要求？

---

## 二、关键设计决策问题

###  1. 关键设计决策 1：为什么需要"终端侧安全边界 = TEE"

#### 1.1 终端面临的本质风险

通用 Android 设备天然面临：

- Root/Hook/调试/注入/模拟器/篡改

- App 进程内存可被窥探、函数可被劫持

- 交易链路中敏感数据可能在“普通世界”暴露

如果把关键敏感操作放在 App 普通进程里，攻击者更容易：

- 窃取密钥或推导密钥材料

- 截获 PIN/交易关键数据

- 篡改交易流程或绕过安全检查

#### 1.2 为什么选 TEE（而不是继续依赖传统 POS 的 SE）

**设计动机**：在通用设备上，尽可能建立“类似传统 POS 安全芯片”的隔离边界。\
TEE 的价值在于：

- **硬件/SoC 级隔离**（Normal World vs Secure World）

- 可把密钥操作、PIN 加密、关键鉴证放到安全世界执行

- 与设备鉴证（Hardware Attestation）结合，更容易形成“设备可信”的证据链

#### 1.3 解决了什么问题

- 让“密钥/PIN/派生”尽量不在普通应用内存中出现

- 提高对 Hook/内存 dump/调试的抵抗力

- 为合规/审计提供更可信的技术论据（“敏感材料在隔离环境处理”）

#### 1.4 代价与缺点（终端研发要提前知道）

- **设备碎片化**：TEE 能力、接口、厂商实现差异大（适配成本上升）

- **调试复杂度**：TA 开发、调用链（JNI/HAL/TEE Client API）排障更难

- **性能与交互**：跨世界调用有开销，需要控制调用频率与数据量

- **供应链风险**：部分机型的 TEE/Attestation 能力不稳定或策略限制多

> 终端侧落地建议：把 TEE 调用做成"少而关键"的接口（例如 PIN 加密、DUKPT 派生、关键材料封装），避免在 TEE 内做大段业务逻辑。

#### 1.5 行业方案对比：其他厂商的终端安全边界实现

| 厂商 | 技术方案 | 优势 | 劣势/挑战 |
| --- | --- | --- | --- |
| **PAX** | SE（安全芯片）+ TEE 混合 | SE 提供更强安全保障、符合传统 POS 审计习惯 | 需要硬件改造、成本较高、灵活性受限 |
| **NEXTGO（新国都）** | TEE + 白盒密码 | 降低对专用硬件依赖、支持更多机型 | 白盒密码方案审计复杂、抗攻击能力存疑 |
| **Stripe** | Cloud HSM + 设备指纹 | 密钥集中管理、便于全球化部署 | 依赖网络、离线场景受限、数据主权问题 |

---

### 2. 关键设计决策 2：为什么密钥体系选 DUKPT（每笔交易唯一密钥）

#### 2.1 终端密钥管理的核心矛盾

终端侧要同时满足：

- 安全：密钥泄露影响面要尽量小

- 可运维：远程注入/更新/吊销要可控

- 可审计：每笔交易的密钥使用要可追溯

#### 2.2 DUKPT 的设计动机

DUKPT 的核心思想是：**每笔交易派生出唯一的交易密钥**。\
这样就算某个交易密钥暴露，也不会波及其它交易（隔离与前向安全更好）。

#### 2.3 解决了什么问题

- **降低单点泄露的爆炸半径**

- **天然支持追踪**（通过 KSN 等序列信息把交易与密钥使用关联）

- 更容易形成“终端密钥生命周期闭环”（注入、派生、计数推进、审计）

#### 2.4 代价与缺点

- **实现复杂**：计数器/同步、KSN 管理、异常恢复都要严谨

- **运维要求高**：注入与派生的边界要清晰，异常状态要可恢复

- **对测试要求高**：需要大量用例验证"重复交易、回滚、并发、断电"等边缘场景

> 终端侧落地建议：把 DUKPT 关键状态（计数器、KSN）与"设备生命周期状态机"强绑定，避免"设备被吊销但密钥状态仍可被使用"。

#### 2.5 行业方案对比：其他厂商的密钥管理方案

| 厂商 | 技术方案 | 优势 | 劣势/挑战 |
| --- | --- | --- | --- |
| **PAX** | 主密钥 + 会话密钥（传统 POS 方案） | 成熟稳定、审计链路清晰、工具链完善 | 单点泄露风险大、密钥更新影响面广 |
| **NEXTGO（新国都）** | DUKPT + 国密算法适配 | 符合国内合规要求、与国际方案兼容 | 双算法维护成本高、测试复杂度上升 |
| **Stripe** | 动态密钥 + Token 化 | 密钥生命周期短、与支付 Token 深度集成 | 高度依赖后端、离线支付受限、厂商锁定 |

---

### 3. 关键设计决策 3：为什么引入 Transaction Token（交易前鉴证）

#### 3.1 终端交易链路的难点：安全与体验冲突

如果每笔交易都做完整健康检查/威胁判断/设备鉴证：

- 安全更强，但交易时延上升、失败率上升、体验变差

如果不做或弱化检查：

- 体验更好，但“带病交易”风险变大，合规与风控承压

#### 3.2 Token 的设计动机：把“交易前安全判定”从交易流程中解耦出来

交易前先拿到一个短期有效的 Token，本质上是：

- 把“设备状态/风险信号/策略判定结果”封装成可验证凭证

- 交易时只做轻量校验，降低关键路径成本

- 兼顾防重放（一次性/有效期/绑定信息）

#### 3.3 解决了什么问题

- **减轻关键路径开销**：安全检查不必每一步都重复做

- **降低重放风险**：Token 具备时效性与一次性语义

- **提高可追溯性**：Token 可作为交易的“前置证据快照”

#### 3.4 代价与缺点

- **复杂度转移**：需要设计 Token 的绑定要素、失效策略、缓存策略

- **一致性问题**：Token 与设备状态变化（如风险升级）之间如何强一致

- **测试负担**：重放/并发/时钟漂移/断网补偿等场景必须覆盖

> 终端侧落地建议：Token 校验失败要能明确区分原因（过期/已用/状态不一致/风控拒绝），并给出可恢复动作（重新申请/重新注册/提示升级/阻断）。

#### 3.5 行业方案对比：其他厂商的交易前鉴证机制

| 厂商 | 技术方案 | 优势 | 劣势/挑战 |
| --- | --- | --- | --- |
| **PAX** | 实时设备鉴证（每笔交易） | 安全性最强、审计链路完整 | 交易时延高、失败率上升、体验较差 |
| **NEXTGO（新国都）** | 定期健康检查 + 风险评分缓存 | 平衡安全与体验、实施成本低 | 缓存窗口期内风险命中响应慢 |
| **Stripe** | 设备指纹 + 行为分析 | 用户无感知、机器学习优化风控 | 高度依赖数据积累、冷启动效果差、误报治理难 |

#### 1-3 章小结：TEE + DUKPT + Token 如何形成完整安全链路

前三章介绍的技术决策不是孤立的，而是协同解决**挑战 2：如何在非可信环境下保证密钥安全与交易可追溯**。

**三个组件的分工与协同**：

- **TEE（第 1 章）**：作为隔离边界，保护密钥材料不被窃取

  - 密钥派生、PIN 加密等敏感操作在硬件隔离的安全世界执行

  - 提高对 Hook/内存 dump/调试的抵抗力

- **DUKPT（第 2 章）**：作为密钥派生机制，保证泄露影响面可控 + 交易可追溯

  - 每笔交易派生唯一密钥，单点泄露不波及其他交易

  - 通过 KSN 序列信息天然支持交易与密钥使用的关联审计

- **Token（第 3 章）**：作为预鉴证机制，保证交易前完成设备安全检查，同时不影响体验

  - 把"设备健康/威胁检测/策略判定"从交易流程中解耦

  - 交易时只做轻量校验，降低关键路径时延

**完整的安全链路**：

1. **设备注册** → A&M 后台审批并下发设备凭证

2. **密钥注入** → 通过 TEE 安全注入初始密钥（BDK）

3. **交易前申请 Token** → App 向 A&M 提交设备状态，后台进行健康评分、威胁检测、策略判定，返回短期有效 Token

4. **交易时 DUKPT 派生** → TEE 内基于计数器派生出本笔交易的唯一密钥，加密敏感数据

5. **后台审计** → A&M 记录 Token 使用、交易记录、KSN 关联，形成完整证据链

这套组合拳形成了**密钥安全 + 交易可追溯 + 体验可控**的闭环，既满足金融级安全要求，又兼顾用户体验与工程可维护性。

---

### 4. 关键设计决策 4：为什么 EMV L2 走 WebAssembly（WASM）内核托管/复用

#### 4.1 现实问题：EMV 内核是"高成本、难维护、强一致性"组件

- 传统 EMV L2 多为 C 资产

- 内核升级频繁（认证、卡组织参数、bugfix）

- 多端/多版本一致性难保证

#### 4.2 设计动机：一次编译，多端复用；升级从“发版 App”变为“分发模块”

把 C 内核编译为 WASM：

- 可以在 Android 与 Web（演示/测试）复用同一份逻辑

- 有利于“动态加载/版本管理/灰度分发”（至少在工程目标上）

- WASM 沙箱隔离一定程度降低内核对宿主的破坏面（但不是安全银弹）

#### 4.3 解决了什么问题

- **复用既有 C 资产**：不必重写一套内核

- **行为一致性**：同一份内核逻辑跨环境验证更容易

- **升级效率**：内核更新更灵活（配合后台版本分发与审计）

#### 4.4 代价与缺点（终端研发要评估）

- **性能与桥接开销**：WASM ↔ Kotlin/Java 的数据传递与调用频次要控制

- **调试复杂**：内核问题定位链路更长（WASM 运行时、桥接层、宿主）

- **兼容性与运行时依赖**：不同 Android 版本、不同运行时实现差异

- **安全边界需明确**：WASM 沙箱 ≠ 处理密钥的安全区；敏感材料仍应在 TEE/受控边界

> 终端侧落地建议：把 WASM 内核当作"确定性状态机"，宿主提供严格的输入输出边界；对内核版本做强约束（版本号、签名校验、回滚策略、灰度策略）。

#### 4.5 行业方案对比：其他厂商的 EMV 内核实现与分发方式

| 厂商 | 技术方案 | 优势 | 劣势/挑战 |
| --- | --- | --- | --- |
| **PAX** | Native C 内核 + 固件升级 | 性能最优、稳定性高、审计成熟 | 升级周期长、跨平台维护成本高 |
| **NEXTGO（新国都）** | Java/Kotlin 重写 + AAR 分发 | 与 Android 生态深度集成、调试友好 | 重写成本高、与 C 资产行为一致性难保证 |
| **Stripe** | 云端托管内核 + 轻量客户端 | 升级无感知、全球一致性最强、安全边界清晰 | 高度依赖网络、离线场景不可用、监管限制 |

---

### 5. 关键设计决策 5：A&M后台为什么需要这些设计

#### 5.1 A&M 后台在 MPoC 合规中的职责

A&M（Admin & Management）后台**本身不是“支付受理终端”**，但它通常承担 MPoC 体系里非常关键的**控制面/证据面**职责：设备与应用的生命周期控制、远程配置与密钥相关流程编排（或对接 KMS/HSM）、安全事件处置、日志与审计证据归档等。

| MPoC 控制目标（抽象） | A&M 功能实现 | 证据/产物（评估可用） |
| --- | --- | --- |
| 终端受控接入与生命周期管理 | 注册/审批/激活/暂停/吊销 | 审批记录、状态变更审计、设备清单导出 |
| 安全配置与版本受控 | 配置中心、内核版本分发、灰度/回滚 | 发布单、版本签名信息、发布审计、回滚记录 |
| 风险监控与事件处置闭环 | 威胁事件、告警、处置流程 | 事件工单、处置人/时间/结果、自动化动作日志 |
| 可追溯与不可抵赖 | 审计日志、日志保留策略、导出 | 审计报表、日志完整性校验说明、证据包导出 |
| 权限与最小授权 | RBAC、操作分权 | 权限配置快照、权限变更审计 |

#### 5.2 终端/应用/配置的受控管理（控制面）

A&M 应该提供：

- **设备注册/审批/启用/暂停/吊销**（你文中已有设备生命周期状态机）

- **版本与配置管理**（应用版本、内核版本、策略配置的发布/灰度/回滚）

- **策略下发与强制执行**（例如：风险命中必须阻断交易、强制升级、强制重新注册）

- **授权与权限（RBAC）**：谁能做什么操作，可审计

为什么这能支撑 MPoC：\
MPoC 不只看“终端是否安全”，还看“系统是否能持续受控地维持安全状态”。A&M 是维持“持续合规”的关键组件。

#### 5.3 安全监控、事件响应与处置闭环（证据面 + 运营面）

A&M 应该提供：

- **健康监控**（设备健康评分、异常趋势、离线率等）

- **威胁事件管理**（Root/Hook/调试/篡改命中、处置状态流转、响应动作）

- **告警与工单/事件记录**（谁处理、何时处理、结果如何）

- **交易侧风控/鉴证关联**（例如 Token 与交易记录/设备快照关联）

#### 5.4 审计日志与可追溯（证据包核心）

A&M 应该提供：

- **关键操作审计**：注册审批、状态变更、密钥相关操作编排、版本发布、策略变更、权限变更

- **不可抵赖性与完整性**：日志防篡改（至少做到链路/签名/落库权限隔离/保留策略）

- **证据导出**：按时间范围导出证据包（版本、配置快照、审计摘要、事件记录）

为什么这能支撑 MPoC：没有"审计与证据"，很多控制要求无法证明满足。

#### 5.5 行业方案对比：其他厂商的后台管理与合规支撑方案

| 厂商 | 技术方案 | 优势 | 劣势/挑战 |
| --- | --- | --- | --- |
| **PAX** | 传统 TMS（终端管理系统）+ 独立审计模块 | 成熟稳定、符合传统 POS 审计习惯、工具链完善 | 架构老旧、SaaS 化程度低、云原生能力弱 |
| **NEXTGO（新国都）** | 混合云管理平台（本地 + SaaS） | 满足数据主权要求、灵活部署 | 一致性维护成本高、跨云审计困难 |
| **Stripe** | 全托管 SaaS 平台 | 开箱即用、全球化、自动合规更新 | 厂商锁定、数据主权受限、定制化能力弱 |

---

## 三、 总体设计概览

### 1. 整体架构设计构想

![image.png](https://cdn.gooo.ai/web-images/ad4b5d7c85dae8d385ab3732b1ca2c86eff7153135a74af8021ab78cc06ba526)

SCRP设备集成架构

![image.png](https://cdn.gooo.ai/web-images/ec06214b4d068e62bb949c3bba1050aaeaed2fdee0abd71b96ba09cbcb691638)

---

### 2. 演示方案五端架构全景

系统按职责拆成（概念上）五块：

- **Android 终端 App**：NFC 交互、UI、终端状态采集、与安全模块/后端交互

- **TEE Trusted Application（TA）**：密钥/PIN 等敏感操作的隔离执行

- **Backend（A/M Server）**：设备生命周期、密钥管理、健康/威胁、交易鉴证与审计

- **Kernel Service / EMV 内核**：EMV L2 逻辑（可托管/可分发）

- **WebKernel Demo**：开发/演示/测试环境（强调：不是生产受理终端）

![](https://cdn.gooo.ai/web-images/777065621c15b9b19161645442dc90e9f41266c1749d1ecd5fb5fa2445e15be1)

---

## 四、Q&A

**Q1：SUNMI在PIN密钥的处理上是TEE方案还是白盒方案？**

**Q2：终端的PIN-PAD方案是什么？**

**Q3：L2 Payment的内核是否会考虑重写成云端WebAssembly版本？**

---