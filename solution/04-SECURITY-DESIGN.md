# SUNBAY SoftPOS 安全设计文档

## 概述

本文档详细描述 SUNBAY SoftPOS 系统的安全架构和实现机制，包括密钥管理、设备认证、威胁检测和数据加密等核心安全特性。

**相关文档**:
- [KSN 标准规范](../../KSN_STANDARD_SPECIFICATION.md)
- [DUKPT 实现](../../sunbay-softpos-backend/src/security/dukpt.rs)
- [威胁处理设计](../../THREAT_HANDLING_DESIGN.md)

---

## 1. 安全架构概览

### 1.1 多层防护体系

```
┌─────────────────────────────────────────────────────────┐
│  应用层安全                                              │
│  - JWT 认证授权                                          │
│  - 角色权限控制                                          │
│  - API 速率限制                                          │
│  - 请求签名验证                                          │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│  传输层安全                                              │
│  - TLS 1.3 加密                                          │
│  - Certificate Pinning                                   │
│  - 双向认证（可选）                                      │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│  数据层安全                                              │
│  - DUKPT 密钥派生                                        │
│  - RSA 公钥加密                                          │
│  - PIN Block 加密（ISO 9564）                            │
│  - 敏感数据脱敏                                          │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│  设备层安全                                              │
│  - TEE 可信执行环境                                      │
│  - Hardware Attestation                                  │
│  - 运行时安全检测                                        │
│  - 防篡改保护                                            │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 密钥管理

### 2.1 DUKPT 密钥体系

详细实现请参考：[KSN 标准规范](../../KSN_STANDARD_SPECIFICATION.md)

### 2.2 密钥生命周期

1. **密钥生成**: TEE 内生成 RSA-2048 密钥对
2. **密钥注入**: 远程注入 IPEK
3. **密钥派生**: 每次交易派生 Working Key
4. **密钥更新**: 剩余次数 < 10% 时更新
5. **密钥销毁**: 设备吊销时销毁

---

## 3. 设备认证

### 3.1 Hardware Attestation

Android 设备通过 Hardware Attestation 验证设备完整性。

### 3.2 设备注册流程

详细流程请参考：[系统架构设计](./02-ARCHITECTURE.md)

---

## 4. 威胁检测

### 4.1 威胁类型和处理

详细设计请参考：[威胁处理设计](../../THREAT_HANDLING_DESIGN.md)

### 4.2 安全评分模型

- Root 检测: -30 分
- Hook 检测: -25 分
- 调试检测: -20 分
- 模拟器检测: -15 分
- TEE 完整性: -30 分
- 系统完整性: -20 分
- 应用完整性: -25 分

基础分 100 分，检测到问题扣分。

---

## 5. 交易安全

### 5.1 交易令牌机制

- 有效期：5 分钟
- 一次性使用
- 包含设备状态和安全评分

### 5.2 PIN 加密

符合 ISO 9564 标准，使用 DUKPT 派生的 Working Key 加密。

---

## 6. 合规性

- **PCI MPoC**: 移动支付终端安全标准
- **ISO 9564**: PIN 加密标准
- **ANSI X9.24**: DUKPT 密钥管理标准

---

**下一步**: 查看 [部署指南](./05-DEPLOYMENT-GUIDE.md)
